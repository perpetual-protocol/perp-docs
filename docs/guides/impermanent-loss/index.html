<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-guides/impermanent-loss">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="search" type="application/opensearchdescription+xml" title="Perpetual Protocol" href="/opensearch.xml"><title data-rh="true">Impermanent Loss Calculation | Perpetual Protocol</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.perp.com/docs/guides/impermanent-loss"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Impermanent Loss Calculation | Perpetual Protocol"><meta data-rh="true" name="description" content="Impermanent Loss is used to described unrealized loss of liquidity due to price fluctuation on AMMs, such as Uniswap and Perp V2."><meta data-rh="true" property="og:description" content="Impermanent Loss is used to described unrealized loss of liquidity due to price fluctuation on AMMs, such as Uniswap and Perp V2."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.perp.com/docs/guides/impermanent-loss"><link data-rh="true" rel="alternate" href="https://docs.perp.com/docs/guides/impermanent-loss" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.perp.com/docs/guides/impermanent-loss" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://3TBGQBHK03-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ed707c1c.css">
<link rel="preload" href="/assets/js/runtime~main.086aae3a.js" as="script">
<link rel="preload" href="/assets/js/main.7f7b9a05.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Perpetual Protocol Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Perpetual Protocol Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Perpetual Protocol</b></a><a class="navbar__item navbar__link" href="/docs/contract-overview">Contracts</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/guides/data-source">Usage Guide</a><a href="https://perpprotocol.mirror.xyz/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/perpetual-protocol/perp-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/contract-overview">Smart Contracts Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/interfaces/IAccountBalance">Interface</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/contracts/AccountBalance">Contracts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/guides/integration-guide">Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/integration-guide">Perp v2 Integration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/data-source">Data Source</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/how-to-get-trader-info">Query Trader Info</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/guides/impermanent-loss">Impermanent Loss Calculation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/referral-program-delegation">Referral Program Delegation Guide for Contracts</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Guides</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Impermanent Loss Calculation</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Impermanent Loss Calculation</h1></header><p><strong>Impermanent Loss</strong> is used to described unrealized loss of liquidity due to price fluctuation on AMMs, such as Uniswap and Perp V2.
As the current price of the pool diverges from the price when the liquidity was first added, the amounts of two tokens in a liquidity range becomes different from the previous states.</p><p>For example, let&#x27;s assume a user Alice adds <code>1 ETH + 0 USDC</code> to a range.
Later, the price changes and Alice&#x27;s <code>1 ETH + 0 USDC</code> becomes <code>0 ETH + 90 USDC</code>.
If the current price of ETH is <code>100 USDC</code>, this means she has <code>10</code> loss, since <code>-1 * 100 (loss from ETH) + 90 (USDC) = -10</code>.</p><p>However, if the current price returns to the original price, the amounts of two tokens will become identical to the original states.
This is the reason for the <strong>impermanent</strong> aspect of the loss, as it is not realized until the liquidity is removed.</p><p>We have written a post for explaining it in more details, see: <a href="https://blog.perp.fi/what-is-impermanent-loss-a9b1359d56f3" target="_blank" rel="noopener noreferrer">What is Impermanent Loss?</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="impermanent-position">Impermanent Position<a class="hash-link" href="#impermanent-position" title="Direct link to heading">​</a></h3><p>On Perp V2, all users, both makers and takers, operate on their positions.
Thus, we refer to makers&#x27; positions as <strong>Impermanent Position</strong> due to their constantly changing size (by contrast, takers&#x27; position sizes won&#x27;t change unless takers manually increase, reduce or close their positions.)</p><p>The total notional value of an impermanent positions is <strong>Impermanent Loss</strong>; in other words, Impermanent Loss is induced from Impermanent Positions on Perp V2.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-calculate-impermanent-loss-on-perp-v2">How to calculate Impermanent Loss on Perp V2?<a class="hash-link" href="#how-to-calculate-impermanent-loss-on-perp-v2" title="Direct link to heading">​</a></h2><p>Since only makers have Impermanent Loss, we can focus on the contract <code>OrderBook</code>, which is responsible for liquidity, or makers&#x27; positions, or <strong>order</strong> as we call in our smart contracts.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-order">Get Order<a class="hash-link" href="#get-order" title="Direct link to heading">​</a></h3><ul><li><code>address trader</code>: the address of the maker to query</li><li><code>address baseToken</code>: the address of the vToken of the market, e.g. vETH or ETH market</li><li><code>int24 lowerTick</code>: the tick of the lower range of an order</li><li><code>int24 upperTick</code>: the tick of the upper range of an order</li></ul><p>If we don&#x27;t know the range (<code>lowerTick</code> &amp; <code>upperTick</code>) of an order: </p><ol><li>get IDs of all orders of a maker: <code>OrderBook.getOpenOrderIds(trader, baseToken)</code></li><li>and get the info of a specific order using its ID: <code>OrderBook.getOpenOrderById(bytes32 orderId)</code></li></ol><p>Else, if we already know the range of an order: <code>OrderBook.getOpenOrder(trader, baseToken, lowerTick, upperTick)</code></p><p>Through the two approaches above, we can get the structure of an order as <code>OpenOrder.Info</code>:</p><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Info</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint128</span><span class="token plain"> liquidity</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">int24</span><span class="token plain"> lowerTick</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">int24</span><span class="token plain"> upperTick</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> lastFeeGrowthInsideX128</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">int256</span><span class="token plain"> lastTwPremiumGrowthInsideX96</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">int256</span><span class="token plain"> lastTwPremiumGrowthBelowX96</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">int256</span><span class="token plain"> lastTwPremiumDivBySqrtPriceGrowthInsideX96</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> baseDebt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> quoteDebt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-current-amounts-of-two-tokens">Get Current Amounts of Two Tokens<a class="hash-link" href="#get-current-amounts-of-two-tokens" title="Direct link to heading">​</a></h3><p>As Perp V2 is built on Uniswap V3, when querying the amounts of two tokens in an order, we&#x27;ll be using Uniswap&#x27;s contract <code>LiquidityAmounts.sol</code> and <code>TickMath.sol</code>.</p><p>First, translate ticks into square root price (<code>sqrtPrice</code>) with function <code>TickMath.getSqrtRatioAtTick(tick)</code>:</p><ul><li><code>uint160 sqrtPriceAtLowerTick = TickMath.getSqrtRatioAtTick(lowerTick)</code></li><li><code>uint160 sqrtPriceAtUpperTick = TickMath.getSqrtRatioAtTick(upperTick)</code></li></ul><p>Then inputting the two values for <code>sqrtPrice</code> and <code>liquidity</code> above, we get from <code>OpenOrder.Info</code> into <code>LiquidityAmounts.getAmount{0,1}ForLiquidity(sqrtPriceAtLowerTick, sqrtPriceAtUpperTick, liquidity)</code></p><ul><li><code>baseToken</code>: <code>LiquidityAmounts.getAmount0ForLiquidity()</code></li><li><code>quoteToken</code>: <code>LiquidityAmounts.getAmount1ForLiquidity()</code></li></ul><p>as <code>baseToken</code> is always <code>token0</code> and <code>quoteToken</code> <code>token1</code> on Perp V2.</p><p>However, when the current price of a pool is between <code>sqrtPriceAtLowerTick</code> and <code>sqrtPriceAtUpperTick</code>, we have to modify the code above by taking the current price <code>sqrtMarkPriceX96</code> into consideration:</p><ul><li><code>baseToken</code></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LiquidityAmounts.getAmount0ForLiquidity(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sqrtMarkPriceX96 &gt; sqrtPriceAtLowerTick ? sqrtMarkPriceX96 : sqrtPriceAtLowerTick,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sqrtPriceAtUpperTick,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liquidity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>quoteToken</code></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LiquidityAmounts.getAmount1ForLiquidity(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sqrtPriceAtLowerTick</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sqrtMarkPriceX96 &lt; sqrtPriceAtUpperTick ? sqrtMarkPriceX96 : sqrtPriceAtUpperTick,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liquidity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The reason for different parameters in the two scenarios is that <code>baseToken</code> gets depleted when the price goes up; thus, the first parameter as the lower range has to move accordingly.
Similarly, <code>quoteToken</code> gets depleted when the price goes down and thus the second parameter as the upper price is dependent on the current price.</p><p>The suffix <code>X96</code> in <code>sqrtMarkPriceX96</code> means the value is scaled by <code>2^96</code> as designed by Uniswap V3. It can be fetched by the first return value of <code>UniswapV3Pool.slot0()</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="token-debt">Token Debt<a class="hash-link" href="#token-debt" title="Direct link to heading">​</a></h3><p>Notice that in the structure <code>OpenOrder.Info</code>, there are <code>baseDebt</code> and <code>quoteDebt</code>.</p><p>The idea of debt is simple: the amount of token a user owes to the exchange.</p><p>Thus, <code>baseDebt</code> is the amount of <code>baseToken</code> and <code>quoteDebt</code>, the amount of <code>quoteToken</code> a user has to pay back when removing liquidity.</p><p>This value is registered when an order is initiated by <code>ClearingHouse.addLiquidity()</code>, e.g. if 1 ETH and 100 USDC are added, <code>baseDebt</code> will be <code>1 * 10^18</code> and <code>quoteDebt</code> <code>100 * 10^6</code>, (ETH&#x27;s decimals are 18 and USDC&#x27;s decimals are 6).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="impermanent-loss-calculation">Impermanent Loss Calculation<a class="hash-link" href="#impermanent-loss-calculation" title="Direct link to heading">​</a></h3><p>Now that we have </p><ol><li>the current amounts of two tokens</li><li>the debt amounts of two tokens</li></ol><p>by simply subtracting them, <strong>the difference</strong> is the <strong>Impermanent Position size</strong>.</p><p>Using the same Alice&#x27;s example above, let&#x27;s see what are the balance changes when her <code>1 ETH + 0 USDC</code> becomes <code>0 ETH + 90 USDC</code>:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="originally">Originally<a class="hash-link" href="#originally" title="Direct link to heading">​</a></h4><ul><li><code>quoteToken debt</code>: <code>0 vUSD</code></li><li><code>baseToken debt</code>: <code>1 vETH</code></li><li><code>current quoteToken amount</code>: <code>0 vUSD</code></li><li><code>current baseToken amount</code>: <code>1 vETH</code></li></ul><p>Alice&#x27;s net token amounts:</p><ul><li><code>baseToken</code>: <code>1 - 1 = 0</code></li><li><code>quoteToken</code>: <code>0 - 10 = 0</code></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="later-when-eth-price-changes">Later when ETH price changes<a class="hash-link" href="#later-when-eth-price-changes" title="Direct link to heading">​</a></h4><ul><li><code>quoteToken debt</code>: <code>0 vUSD</code></li><li><code>baseToken debt</code>: <code>1 vETH</code></li><li><code>current quoteToken amount</code>: <code>90 vUSD</code></li><li><code>current baseToken amount</code>: <code>0 vETH</code></li></ul><p>Alice&#x27;s net token amounts:</p><ul><li><code>baseToken</code>: <code>0 - 1 = -1</code></li><li><code>quoteToken</code>: <code>90 - 0 = 90</code></li></ul><p>So we can see that Alice&#x27;s Impermanent Loss in this scenario is <code>-1 * 100 (loss from ETH) + 90 (USD) = -10</code>, or <code>-1 * 100 + 90 * 1 = -10</code>.</p><p>The reason is that <code>vUSD</code> is the <strong>settlement token</strong>, meaning that <code>vUSD</code> is always the <code>quoteToken</code> in any market on Perp V2.</p><p>Thus, all <code>baseToken</code> prices are denominated in <code>vUSD</code>, as <code>vETH</code> in this case is <code>100</code>, since <code>1 vETH = 100 vUSD</code>.</p><p>The price of <code>vUSD</code>, denominated in itself, is of course, <code>1</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/perpetual-protocol/perp-docs/tree/main/docs/guides/ImpermanentLoss.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/guides/how-to-get-trader-info"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Query Trader Info</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/guides/referral-program-delegation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Referral Program Delegation Guide for Contracts</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#impermanent-position" class="table-of-contents__link toc-highlight">Impermanent Position</a></li><li><a href="#how-to-calculate-impermanent-loss-on-perp-v2" class="table-of-contents__link toc-highlight">How to calculate Impermanent Loss on Perp V2?</a><ul><li><a href="#get-order" class="table-of-contents__link toc-highlight">Get Order</a></li><li><a href="#get-current-amounts-of-two-tokens" class="table-of-contents__link toc-highlight">Get Current Amounts of Two Tokens</a></li><li><a href="#token-debt" class="table-of-contents__link toc-highlight">Token Debt</a></li><li><a href="#impermanent-loss-calculation" class="table-of-contents__link toc-highlight">Impermanent Loss Calculation</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://app.perp.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Launch App</a></li><li class="footer__item"><a href="https://token.perp.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Token</a></li><li class="footer__item"><a href="https://perp.com/featured-partners" target="_blank" rel="noopener noreferrer" class="footer__link-item">Third-party Vaults</a></li></ul></div><div class="col footer__col"><div class="footer__title">Protocol</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://perp.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">About</a></li><li class="footer__item"><a href="https://blog.perp.fi/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://www.getrevue.co/profile/perpprotocol/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter</a></li><li class="footer__item"><a href="https://jobs.perp.fi/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jobs</a></li><li class="footer__item"><a href="https://shop.perp.fi/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Shop</a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="http://support.perp.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">FAQ</a></li><li class="footer__item"><a href="https://perp.com/developers" target="_blank" rel="noopener noreferrer" class="footer__link-item">Developers</a></li><li class="footer__item"><a href="https://perp.com/learn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Learn</a></li><li class="footer__item"><a href="https://perp.com/ecosystem" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ecosystem</a></li><li class="footer__item"><a href="https://perp.com/perpvangelist" target="_blank" rel="noopener noreferrer" class="footer__link-item">Perpvangelist</a></li><li class="footer__item"><a href="https://perp.com/governance" target="_blank" rel="noopener noreferrer" class="footer__link-item">Governance</a></li><li class="footer__item"><a href="https://perp.com/branding" target="_blank" rel="noopener noreferrer" class="footer__link-item">Brand</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/perpprotocol" target="_blank" rel="noopener noreferrer" class="footer__link-item" img="twitterIcon">Twitter</a></li><li class="footer__item"><a href="https://www.youtube.com/c/PerpetualProtocol" target="_blank" rel="noopener noreferrer" class="footer__link-item" img="youtubeIcon">YouTube</a></li><li class="footer__item"><a href="https://discord.com/invite/Dq9mTmCaBb" target="_blank" rel="noopener noreferrer" class="footer__link-item" img="discordIcon">Discord</a></li><li class="footer__item"><a href="https://t.me/perpetualprotocol" target="_blank" rel="noopener noreferrer" class="footer__link-item" img="telegramIcon">Telegram</a></li><li class="footer__item"><a href="https://perpetualprotocol.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item" img="mediumIcon">Medium</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Perpetual Protocol. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.086aae3a.js"></script>
<script src="/assets/js/main.7f7b9a05.js"></script>
</body>
</html>